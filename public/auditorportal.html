<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TulKenz OPS ‚Äî Auditor Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #F8F9FB;
      --surface: #FFFFFF;
      --border: #E2E5EB;
      --text: #1A1D23;
      --text-secondary: #5F6673;
      --text-tertiary: #9BA3B0;
      --primary: #6C5CE7;
      --primary-light: #6C5CE710;
      --primary-mid: #6C5CE730;
      --green: #00B894;
      --green-light: #00B89410;
      --red: #FF6B6B;
      --red-light: #FF6B6B10;
      --yellow: #FDCB6E;
      --yellow-light: #FDCB6E15;
      --sidebar-w: 280px;
      --header-h: 64px;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      --shadow-lg: 0 4px 12px rgba(0,0,0,0.08);
    }

    body {
      font-family: 'DM Sans', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* ‚îÄ‚îÄ LOADING / ERROR SCREENS ‚îÄ‚îÄ */
    .fullscreen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
      padding: 24px;
    }
    .fullscreen .logo { font-size: 28px; font-weight: 700; color: var(--primary); letter-spacing: -0.5px; }
    .fullscreen .sub { font-size: 15px; color: var(--text-secondary); text-align: center; max-width: 400px; line-height: 1.5; }
    .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .status-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 32px;
      max-width: 440px;
      text-align: center;
      box-shadow: var(--shadow-lg);
    }
    .status-card .icon { font-size: 48px; margin-bottom: 12px; }
    .status-card h2 { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
    .status-card p { font-size: 14px; color: var(--text-secondary); line-height: 1.5; }

    /* Token entry */
    .token-input-wrap { display: flex; gap: 8px; margin-top: 16px; }
    .token-input {
      flex: 1; padding: 12px 16px; border: 1px solid var(--border); border-radius: var(--radius-sm);
      font-size: 14px; font-family: 'JetBrains Mono', monospace; outline: none;
    }
    .token-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
    .token-btn {
      padding: 12px 24px; background: var(--primary); color: #fff; border: none; border-radius: var(--radius-sm);
      font-size: 14px; font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif;
    }
    .token-btn:hover { opacity: 0.9; }

    /* ‚îÄ‚îÄ PORTAL LAYOUT ‚îÄ‚îÄ */
    .portal { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-w);
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      z-index: 10;
      overflow-y: auto;
    }
    .sidebar-brand {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-brand .name { font-size: 16px; font-weight: 700; color: var(--primary); }
    .sidebar-brand .type { font-size: 11px; color: var(--text-tertiary); margin-top: 2px; text-transform: uppercase; letter-spacing: 0.5px; }
    .sidebar-info {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--primary-light);
    }
    .sidebar-info .label { font-size: 11px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
    .sidebar-info .val { font-size: 13px; font-weight: 500; color: var(--text); }
    .sidebar-info .row { margin-bottom: 8px; }
    .sidebar-info .row:last-child { margin-bottom: 0; }
    .sidebar-nav { flex: 1; padding: 12px 0; overflow-y: auto; }
    .nav-section { padding: 8px 20px 4px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-tertiary); font-weight: 600; }
    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 20px; cursor: pointer; font-size: 14px; color: var(--text-secondary);
      transition: all 0.15s;
    }
    .nav-item:hover { background: var(--bg); color: var(--text); }
    .nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
    .nav-item .sqf { font-size: 11px; color: var(--text-tertiary); margin-left: auto; font-family: 'JetBrains Mono', monospace; }
    .nav-item.active .sqf { color: var(--primary); opacity: 0.7; }
    .sidebar-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      font-size: 11px;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Main content */
    .main {
      margin-left: var(--sidebar-w);
      flex: 1;
      min-height: 100vh;
    }
    .header {
      height: var(--header-h);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      position: sticky;
      top: 0;
      z-index: 5;
    }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-title { font-size: 18px; font-weight: 700; }
    .header-sqf { font-size: 12px; color: var(--text-tertiary); font-family: 'JetBrains Mono', monospace; }
    .badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600;
    }
    .badge-green { background: var(--green-light); color: var(--green); }
    .badge-red { background: var(--red-light); color: var(--red); }
    .badge-yellow { background: var(--yellow-light); color: #B7791F; }

    .content { padding: 24px; }

    /* Welcome */
    .welcome-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; margin-top: 20px; }
    .welcome-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 20px; cursor: pointer; transition: all 0.2s;
    }
    .welcome-card:hover { border-color: var(--primary-mid); box-shadow: var(--shadow-lg); transform: translateY(-2px); }
    .welcome-card .icon { font-size: 28px; margin-bottom: 10px; }
    .welcome-card .name { font-size: 15px; font-weight: 600; }
    .welcome-card .ref { font-size: 12px; color: var(--text-tertiary); font-family: 'JetBrains Mono', monospace; margin-top: 4px; }

    .welcome-banner {
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 24px; box-shadow: var(--shadow);
    }
    .welcome-banner h2 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .welcome-banner p { font-size: 14px; color: var(--text-secondary); line-height: 1.5; }
    .welcome-meta { display: flex; gap: 24px; margin-top: 16px; flex-wrap: wrap; }
    .welcome-meta .item { font-size: 13px; }
    .welcome-meta .label { color: var(--text-tertiary); }
    .welcome-meta .val { font-weight: 600; margin-left: 4px; }

    /* Records */
    .search-bar {
      display: flex; align-items: center; gap: 8px;
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm);
      padding: 10px 16px; margin-bottom: 16px;
    }
    .search-bar input { border: none; outline: none; flex: 1; font-size: 14px; font-family: 'DM Sans', sans-serif; background: transparent; }
    .search-bar .count { font-size: 12px; color: var(--text-tertiary); white-space: nowrap; }

    .record-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
      margin-bottom: 8px; overflow: hidden; transition: all 0.2s;
    }
    .record-card:hover { border-color: var(--primary-mid); }
    .record-header {
      padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;
    }
    .record-header .left { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
    .record-header .form-num {
      font-size: 11px; font-family: 'JetBrains Mono', monospace; color: var(--primary);
      background: var(--primary-light); padding: 2px 8px; border-radius: 4px; white-space: nowrap;
    }
    .record-header .title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .record-header .date { font-size: 12px; color: var(--text-tertiary); white-space: nowrap; margin-left: 8px; }
    .record-header .arrow { color: var(--text-tertiary); transition: transform 0.2s; font-size: 18px; }
    .record-header .arrow.open { transform: rotate(180deg); }

    .record-detail {
      display: none; padding: 0 16px 16px; border-top: 1px solid var(--border);
    }
    .record-detail.open { display: block; padding-top: 12px; }
    .detail-grid { display: grid; grid-template-columns: 140px 1fr; gap: 6px 16px; }
    .detail-grid .label { font-size: 12px; font-weight: 600; color: var(--text-secondary); }
    .detail-grid .value { font-size: 13px; word-break: break-word; }

    .record-status {
      display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase;
    }
    .status-open, .status-pending, .status-in_progress, .status-active { background: var(--yellow-light); color: #B7791F; }
    .status-closed, .status-completed, .status-pass, .status-verified, .status-approved { background: var(--green-light); color: #0A6847; }
    .status-overdue, .status-fail, .status-failed, .status-rejected, .status-critical { background: var(--red-light); color: #C0392B; }

    .loading-records { text-align: center; padding: 48px; color: var(--text-tertiary); }

    /* Security Controls */
    .controls-section { margin-bottom: 24px; }
    .controls-section h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
    .controls-section .sqf-ref { font-size: 12px; color: var(--primary); font-family: 'JetBrains Mono', monospace; margin-bottom: 12px; }
    .controls-section ul { list-style: none; padding: 0; }
    .controls-section li { padding: 6px 0; font-size: 14px; color: var(--text-secondary); display: flex; align-items: flex-start; gap: 8px; }
    .controls-section li::before { content: '‚úì'; color: var(--green); font-weight: 700; flex-shrink: 0; }

    .system-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .system-table th, .system-table td { padding: 10px 16px; text-align: left; border-bottom: 1px solid var(--border); font-size: 13px; }
    .system-table th { font-weight: 600; color: var(--text-secondary); background: var(--bg); }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main { margin-left: 0; }
    }
  </style>
</head>
<body>

<div id="app"></div>

<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
const SUPABASE_URL = 'https://xaqztozcnkpmgytnnjlj.supabase.co';
const SUPABASE_ANON_KEY = (() => {
  // We'll read it from a meta tag or hardcode ‚Äî get from your Supabase dashboard Settings > API > anon/public
  // This is safe to expose ‚Äî RLS protects data
  const el = document.querySelector('meta[name="supabase-anon-key"]');
  return el ? el.content : '';
})();

// Try to get key from the supabase client script globals or fallback
let sb = null;

const MODULE_DEFS = [
  { key: 'documents', scope: 'scope_documents', label: 'Documents', sqf: 'SQF 2.2.2', icon: 'üìÑ', table: 'documents', nameField: 'name', dateField: 'created_at', statusField: 'status' },
  { key: 'ncrs', scope: 'scope_ncrs', label: 'NCRs', sqf: 'SQF 2.5.3', icon: '‚ö†Ô∏è', table: 'ncr_records', nameField: 'description', dateField: 'created_at', statusField: 'status' },
  { key: 'capas', scope: 'scope_capas', label: 'CAPAs', sqf: 'SQF 2.5.4', icon: 'üìã', table: 'capas', nameField: 'description', dateField: 'created_at', statusField: 'status' },
  { key: 'training', scope: 'scope_training', label: 'Training Records', sqf: 'SQF 2.1.1.6', icon: 'üéì', table: 'employee_training_progress', nameField: 'course_name', dateField: 'created_at', statusField: 'status' },
  { key: 'internal_audits', scope: 'scope_internal_audits', label: 'Internal Audits', sqf: 'SQF 2.5.1', icon: 'üîç', table: 'internal_audits', nameField: 'audit_name', dateField: 'created_at', statusField: 'status' },
  { key: 'haccp', scope: 'scope_haccp', label: 'HACCP Plans', sqf: 'SQF 2.4.3', icon: 'üõ°Ô∏è', table: 'haccp_plans', nameField: 'plan_name', dateField: 'created_at', statusField: 'status' },
  { key: 'supplier_approvals', scope: 'scope_supplier_approvals', label: 'Supplier Approvals', sqf: 'SQF 2.3.2', icon: 'üöö', table: 'suppliers', nameField: 'name', dateField: 'created_at', statusField: 'status' },
  { key: 'env_monitoring', scope: 'scope_env_monitoring', label: 'Environmental Monitoring', sqf: 'SQF 11.2.8', icon: 'üî¨', table: 'env_monitoring_results', nameField: 'location', dateField: 'created_at', statusField: 'result' },
  { key: 'change_management', scope: 'scope_change_management', label: 'Change Management', sqf: 'SQF Ed10', icon: 'üîÑ', table: 'change_requests', nameField: 'title', dateField: 'created_at', statusField: 'status' },
  { key: 'food_safety_culture', scope: 'scope_food_safety_culture', label: 'Food Safety Culture', sqf: 'SQF 2.1.3', icon: '‚ù§Ô∏è', table: 'food_safety_culture', nameField: 'title', dateField: 'created_at', statusField: 'status' },
  { key: 'work_orders', scope: 'scope_work_orders', label: 'Work Orders', sqf: 'SQF 11.1.3', icon: 'üîß', table: 'work_orders', nameField: 'title', dateField: 'created_at', statusField: 'status' },
  { key: 'inventory', scope: 'scope_inventory', label: 'Inventory', sqf: 'SQF 2.3', icon: 'üì¶', table: 'inventory_items', nameField: 'name', dateField: 'created_at', statusField: 'status' },
  { key: 'backup_verification', scope: 'scope_security_controls', label: 'Backup Verification', sqf: 'SQF 2.2.3.3', icon: 'üíæ', table: 'backup_verification_log', nameField: 'description', dateField: 'backup_date', statusField: 'verification_result' },
];

const HIDDEN_FIELDS = ['id', 'organization_id', 'created_by_id', 'performed_by_id', 'verified_by_id', 'verifier_pin_verified', 'pin', 'pin_hash', 'password', 'token', 'token_hash', 'access_token'];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let session = null;
let activeModule = null;
let records = [];
let searchQuery = '';

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
async function init() {
  const app = document.getElementById('app');
  app.innerHTML = renderLoading('Validating access token...');

  // Get token from URL
  const params = new URLSearchParams(window.location.search);
  let token = params.get('token');

  if (!token) {
    app.innerHTML = renderTokenEntry();
    return;
  }

  await validateToken(token);
}

async function initSupabase() {
  if (sb) return;
  // Fetch anon key from Supabase ‚Äî we'll use a known endpoint
  // Actually, we need to provide the anon key. Let's fetch it from an env or hardcode.
  // For now we'll prompt the config
  try {
    // Try to get anon key from the page or use the one from the project
    const response = await fetch(SUPABASE_URL + '/rest/v1/', {
      headers: { 'apikey': 'placeholder' }
    });
    // This won't work but let's try another approach
  } catch(e) {}

  // The anon key needs to be provided. Let's try reading from a script tag data attribute
  const scriptEl = document.querySelector('script[data-anon-key]');
  const anonKey = scriptEl ? scriptEl.dataset.anonKey : window.SUPABASE_ANON_KEY || '';

  if (!anonKey) {
    document.getElementById('app').innerHTML = renderError('Configuration Error', 'Supabase anon key not configured. Contact the system administrator.');
    return false;
  }

  sb = window.supabase.createClient(SUPABASE_URL, anonKey);
  return true;
}

async function validateToken(token) {
  const app = document.getElementById('app');

  if (!(await initSupabase())) return;

  // Look up session by token
  const { data, error } = await sb.from('audit_sessions')
    .select('*')
    .eq('access_token', token)
    .single();

  if (error || !data) {
    app.innerHTML = renderStatus('üîí', 'Invalid Token', 'This access token is not recognized. Please check the link provided to you.');
    return;
  }

  // Check status
  if (data.status === 'revoked') {
    app.innerHTML = renderStatus('üö´', 'Access Revoked', `This audit session was revoked on ${fmtDate(data.revoked_at)}. Reason: ${data.revoke_reason || 'Not specified'}.`);
    return;
  }

  const now = new Date();
  const validFrom = new Date(data.valid_from);
  const validUntil = new Date(data.valid_until);

  if (now < validFrom) {
    app.innerHTML = renderStatus('‚è≥', 'Not Yet Active', `This audit session begins on ${fmtDate(data.valid_from)}. Please return after that date.`);
    return;
  }

  if (now > validUntil) {
    // Auto-expire
    await sb.from('audit_sessions').update({ status: 'expired' }).eq('id', data.id);
    app.innerHTML = renderStatus('‚åõ', 'Session Expired', `This audit session expired on ${fmtDate(data.valid_until)}. Contact the facility to request a new session.`);
    return;
  }

  // Valid! Update access tracking
  session = data;
  await sb.from('audit_sessions').update({
    last_accessed_at: new Date().toISOString(),
    access_count: (data.access_count || 0) + 1,
  }).eq('id', data.id);

  // Log access
  await logAccess('portal', 'login', null, null, 'Portal accessed');

  renderPortal();
}

// ‚îÄ‚îÄ ACCESS LOGGING ‚îÄ‚îÄ
async function logAccess(module, action, resourceId, resourceType, resourceName) {
  if (!sb || !session) return;
  try {
    await sb.from('audit_access_log').insert({
      session_id: session.id,
      organization_id: session.organization_id,
      module: module,
      action: action,
      resource_id: resourceId,
      resource_type: resourceType,
      resource_name: resourceName,
    });
  } catch(e) { console.warn('Log error:', e); }
}

// ‚îÄ‚îÄ RENDER HELPERS ‚îÄ‚îÄ
function renderLoading(msg) {
  return `<div class="fullscreen"><div class="logo">TulKenz OPS</div><div class="spinner"></div><div class="sub">${msg}</div></div>`;
}

function renderStatus(icon, title, message) {
  return `<div class="fullscreen"><div class="status-card"><div class="icon">${icon}</div><h2>${title}</h2><p>${message}</p></div></div>`;
}

function renderError(title, message) {
  return renderStatus('‚ùå', title, message);
}

function renderTokenEntry() {
  return `
    <div class="fullscreen">
      <div class="status-card">
        <div class="icon">üîê</div>
        <h2>Auditor Portal</h2>
        <p>Enter the access token provided to you to view audit documents.</p>
        <div class="token-input-wrap">
          <input type="text" class="token-input" id="tokenInput" placeholder="Paste access token..." />
          <button class="token-btn" onclick="submitToken()">Verify</button>
        </div>
      </div>
    </div>
  `;
}

function submitToken() {
  const input = document.getElementById('tokenInput');
  if (input && input.value.trim()) {
    document.getElementById('app').innerHTML = renderLoading('Validating access token...');
    validateToken(input.value.trim());
  }
}

function fmtDate(iso) {
  if (!iso) return '‚Äî';
  return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function fmtDateTime(iso) {
  if (!iso) return '‚Äî';
  const d = new Date(iso);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + ' ' +
    d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
}

function daysRemaining() {
  const until = new Date(session.valid_until);
  const now = new Date();
  return Math.max(0, Math.ceil((until - now) / (1000 * 60 * 60 * 24)));
}

function getEnabledModules() {
  return MODULE_DEFS.filter(m => session[m.scope] === true);
}

function getStatusClass(status) {
  if (!status) return '';
  const s = status.toLowerCase().replace(/\s+/g, '_');
  return `status-${s}`;
}

// ‚îÄ‚îÄ RENDER PORTAL ‚îÄ‚îÄ
function renderPortal() {
  const app = document.getElementById('app');
  const modules = getEnabledModules();
  const auditTypeLabels = { sqf: 'SQF', brcgs: 'BRCGS', fssc: 'FSSC 22000', internal: 'Internal', regulatory: 'Regulatory', customer: 'Customer', other: 'Other' };
  const days = daysRemaining();

  app.innerHTML = `
    <div class="portal">
      <aside class="sidebar">
        <div class="sidebar-brand">
          <div class="name">TulKenz OPS</div>
          <div class="type">Auditor Portal ‚Äî Read Only</div>
        </div>
        <div class="sidebar-info">
          <div class="row"><div class="label">Session</div><div class="val">${esc(session.session_name)}</div></div>
          <div class="row"><div class="label">Auditor</div><div class="val">${esc(session.auditor_name)}</div></div>
          <div class="row"><div class="label">Certification Body</div><div class="val">${esc(session.certification_body)}</div></div>
          <div class="row"><div class="label">Audit Type</div><div class="val">${auditTypeLabels[session.audit_type] || session.audit_type}</div></div>
          <div class="row"><div class="label">Access Window</div><div class="val">${fmtDate(session.valid_from)} ‚Äî ${fmtDate(session.valid_until)}</div></div>
          <div class="row"><span class="badge badge-green">‚óè Active ‚Äî ${days} day${days !== 1 ? 's' : ''} remaining</span></div>
        </div>
        <nav class="sidebar-nav">
          <div class="nav-section">Modules</div>
          <div class="nav-item active" onclick="showWelcome()" id="nav-welcome">
            üìä Overview
          </div>
          ${modules.map(m => `
            <div class="nav-item" onclick="showModule('${m.key}')" id="nav-${m.key}">
              ${m.icon} ${esc(m.label)}
              <span class="sqf">${m.sqf}</span>
            </div>
          `).join('')}
          <div class="nav-section" style="margin-top:12px">Compliance</div>
          <div class="nav-item" onclick="showSecurityControls()" id="nav-security">
            üîí Security Controls
          </div>
        </nav>
        <div class="sidebar-footer">üîí Read-only access ¬∑ All activity logged</div>
      </aside>

      <div class="main">
        <div class="header">
          <div class="header-left">
            <div class="header-title" id="headerTitle">Overview</div>
            <div class="header-sqf" id="headerSqf"></div>
          </div>
          <span class="badge badge-green">‚óè Active Session</span>
        </div>
        <div class="content" id="mainContent">
          ${renderWelcome(modules)}
        </div>
      </div>
    </div>
  `;
}

function esc(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function renderWelcome(modules) {
  const days = daysRemaining();
  return `
    <div class="welcome-banner">
      <h2>Welcome, ${esc(session.auditor_name)}</h2>
      <p>You have read-only access to ${modules.length} module${modules.length !== 1 ? 's' : ''} for this ${session.audit_type.toUpperCase()} audit session. All access is logged.</p>
      <div class="welcome-meta">
        <div class="item"><span class="label">Session:</span><span class="val">${esc(session.session_name)}</span></div>
        <div class="item"><span class="label">CB:</span><span class="val">${esc(session.certification_body)}</span></div>
        <div class="item"><span class="label">Expires:</span><span class="val">${fmtDate(session.valid_until)} (${days} days)</span></div>
        <div class="item"><span class="label">Access Count:</span><span class="val">${session.access_count || 1}</span></div>
      </div>
    </div>
    <h3 style="margin-top:24px;font-size:16px;font-weight:600;">Available Modules</h3>
    <div class="welcome-grid">
      ${modules.map(m => `
        <div class="welcome-card" onclick="showModule('${m.key}')">
          <div class="icon">${m.icon}</div>
          <div class="name">${esc(m.label)}</div>
          <div class="ref">${m.sqf}</div>
        </div>
      `).join('')}
      <div class="welcome-card" onclick="showSecurityControls()">
        <div class="icon">üîí</div>
        <div class="name">Security Controls</div>
        <div class="ref">SQF 2.2.2 / 2.2.3</div>
      </div>
    </div>
  `;
}

// ‚îÄ‚îÄ NAV ACTIONS ‚îÄ‚îÄ
function setActiveNav(id) {
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
}

function showWelcome() {
  setActiveNav('nav-welcome');
  document.getElementById('headerTitle').textContent = 'Overview';
  document.getElementById('headerSqf').textContent = '';
  const modules = getEnabledModules();
  document.getElementById('mainContent').innerHTML = renderWelcome(modules);
  activeModule = null;
}

async function showModule(key) {
  const mod = MODULE_DEFS.find(m => m.key === key);
  if (!mod) return;

  activeModule = mod;
  setActiveNav('nav-' + key);
  document.getElementById('headerTitle').textContent = mod.label;
  document.getElementById('headerSqf').textContent = mod.sqf;
  document.getElementById('mainContent').innerHTML = `<div class="loading-records"><div class="spinner" style="margin:0 auto"></div><p style="margin-top:12px">Loading ${mod.label}...</p></div>`;

  await logAccess(mod.key, 'view_module', null, mod.table, mod.label);

  try {
    const { data, error } = await sb.from(mod.table)
      .select('*')
      .eq('organization_id', session.organization_id)
      .order(mod.dateField, { ascending: false })
      .limit(500);

    if (error) throw error;
    records = data || [];
  } catch(e) {
    console.warn('Fetch error:', e);
    records = [];
  }

  searchQuery = '';
  renderRecords();
}

function renderRecords() {
  const mod = activeModule;
  const filtered = searchQuery
    ? records.filter(r => JSON.stringify(r).toLowerCase().includes(searchQuery.toLowerCase()))
    : records;

  const content = document.getElementById('mainContent');
  content.innerHTML = `
    <div class="search-bar">
      <span>üîç</span>
      <input type="text" placeholder="Search ${mod.label}..." value="${esc(searchQuery)}" oninput="onSearch(this.value)" />
      <span class="count">${filtered.length} record${filtered.length !== 1 ? 's' : ''}</span>
    </div>
    ${filtered.length === 0
      ? `<div class="loading-records"><p>No records found${searchQuery ? ' matching your search' : ''}.</p></div>`
      : filtered.map((r, i) => renderRecordCard(r, i, mod)).join('')
    }
  `;
}

function onSearch(val) {
  searchQuery = val;
  renderRecords();
}

function renderRecordCard(record, index, mod) {
  const name = record[mod.nameField] || record.title || record.name || record.description || 'Untitled';
  const date = record[mod.dateField] || record.created_at;
  const status = record[mod.statusField] || '';
  const formNum = record.form_number || record.form_id || '';

  return `
    <div class="record-card" id="record-${index}">
      <div class="record-header" onclick="toggleRecord(${index}, '${esc(name)}')">
        <div class="left">
          ${formNum ? `<span class="form-num">${esc(formNum)}</span>` : ''}
          <span class="title">${esc(name)}</span>
          <span class="date">${fmtDate(date)}</span>
        </div>
        ${status ? `<span class="record-status ${getStatusClass(status)}">${esc(status)}</span>` : ''}
        <span class="arrow" id="arrow-${index}">‚ñº</span>
      </div>
      <div class="record-detail" id="detail-${index}">
        <div class="detail-grid">
          ${Object.entries(record)
            .filter(([k]) => !HIDDEN_FIELDS.includes(k))
            .map(([k, v]) => {
              if (v === null || v === undefined || v === '') return '';
              const label = k.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
              let val = v;
              if (typeof v === 'boolean') val = v ? 'Yes' : 'No';
              else if (typeof v === 'string' && v.match(/^\d{4}-\d{2}-\d{2}T/)) val = fmtDateTime(v);
              else if (Array.isArray(v)) val = v.join(', ');
              else if (typeof v === 'object') val = JSON.stringify(v, null, 2);
              return `<div class="label">${esc(label)}</div><div class="value">${esc(String(val))}</div>`;
            }).join('')}
        </div>
      </div>
    </div>
  `;
}

async function toggleRecord(index, name) {
  const detail = document.getElementById('detail-' + index);
  const arrow = document.getElementById('arrow-' + index);
  if (detail.classList.contains('open')) {
    detail.classList.remove('open');
    arrow.classList.remove('open');
  } else {
    detail.classList.add('open');
    arrow.classList.add('open');
    // Log record view
    const record = records[index];
    if (record && activeModule) {
      await logAccess(activeModule.key, 'view_record', record.id, activeModule.table, name);
    }
  }
}

// ‚îÄ‚îÄ SECURITY CONTROLS ‚îÄ‚îÄ
function showSecurityControls() {
  setActiveNav('nav-security');
  document.getElementById('headerTitle').textContent = 'Document Security Controls';
  document.getElementById('headerSqf').textContent = 'SQF 2.2.2 / 2.2.3';
  activeModule = null;

  logAccess('security_controls', 'view_module', null, null, 'Document Security Controls');

  document.getElementById('mainContent').innerHTML = `
    <div class="welcome-banner" style="margin-bottom:24px">
      <h2>Electronic Record Security Controls</h2>
      <p>This document describes the security controls implemented in TulKenz OPS to protect electronic records in compliance with SQF Code requirements for document control, electronic signatures, and data security.</p>
      <table class="system-table" style="margin-top:16px">
        <tr><th>Attribute</th><th>Detail</th></tr>
        <tr><td>Platform</td><td>TulKenz OPS ‚Äî Cloud Food Safety Management System</td></tr>
        <tr><td>Database</td><td>PostgreSQL via Supabase (AWS)</td></tr>
        <tr><td>Hosting</td><td>Vercel Pro ‚Äî Global CDN, SSL, DDoS Protection</td></tr>
        <tr><td>Encryption</td><td>AES-256 at rest, TLS 1.3 in transit</td></tr>
        <tr><td>Auth Method</td><td>PIN-based employee authentication</td></tr>
        <tr><td>Signature Method</td><td>PPN (Personal PIN + Initials + Department Code)</td></tr>
        <tr><td>Client Apps</td><td>iOS, Android, Web (Progressive Web App)</td></tr>
        <tr><td>Backup</td><td>Automated daily ‚Äî verified via Management API</td></tr>
      </table>
    </div>

    <div class="controls-section">
      <h3>1. Access Control & Authentication</h3>
      <div class="sqf-ref">SQF 2.2.2.3</div>
      <ul>
        <li>Organization-scoped data isolation ‚Äî each facility's data is completely separated</li>
        <li>Role-based access control with granular module permissions</li>
        <li>PIN-based authentication for all employee actions</li>
        <li>Session timeout after period of inactivity</li>
        <li>Failed authentication attempts are tracked and logged</li>
      </ul>
    </div>

    <div class="controls-section">
      <h3>2. Electronic Signatures ‚Äî PPN Verification</h3>
      <div class="sqf-ref">SQF 2.2.3.2</div>
      <ul>
        <li>Two-factor verification: Employee initials + PIN entry</li>
        <li>Immutable signature stamps include name, department, date, and time</li>
        <li>Signature verification status recorded on every signed document</li>
        <li>Failed signature attempts logged for security audit trail</li>
        <li>Signatures cannot be modified after submission</li>
      </ul>
    </div>

    <div class="controls-section">
      <h3>3. Document Version Control</h3>
      <div class="sqf-ref">SQF 2.2.2.2</div>
      <ul>
        <li>Template-based document system with unique form IDs</li>
        <li>Version history maintained for all document templates</li>
        <li>Approval tracking with reviewer identification and timestamps</li>
        <li>Superseded documents archived, not deleted</li>
      </ul>
    </div>

    <div class="controls-section">
      <h3>4. Data Storage & Security</h3>
      <div class="sqf-ref">SQF 2.2.3.3</div>
      <ul>
        <li>PostgreSQL database hosted on Supabase (AWS infrastructure)</li>
        <li>AES-256 encryption at rest for all stored data</li>
        <li>TLS 1.3 encryption in transit for all API communications</li>
        <li>Row Level Security (RLS) policies enforced at database level</li>
        <li>Automated daily backups with verification monitoring</li>
        <li>Point-in-time recovery capability</li>
      </ul>
    </div>

    <div class="controls-section">
      <h3>5. Audit Trail & Activity Logging</h3>
      <div class="sqf-ref">SQF 2.2.3.1</div>
      <ul>
        <li>created_at, updated_at, and created_by fields on all records</li>
        <li>PPN signature log with full verification chain</li>
        <li>No hard deletes ‚Äî soft delete pattern preserves all historical data</li>
        <li>External auditor access fully logged with IP, user agent, and timestamps</li>
      </ul>
    </div>

    <div class="controls-section">
      <h3>6. User Management & Authorization</h3>
      <div class="sqf-ref">SQF 2.1.1</div>
      <ul>
        <li>Centralized employee directory with department assignments</li>
        <li>Role-based permission system with module-level granularity</li>
        <li>Admin-only functions for user creation and role assignment</li>
        <li>Employee status tracking (active, inactive, terminated)</li>
      </ul>
    </div>

    <div class="controls-section">
      <h3>7. Record Retention & Retrieval</h3>
      <div class="sqf-ref">SQF 2.2.3.3</div>
      <ul>
        <li>Indefinite record retention ‚Äî no automatic deletion of compliance data</li>
        <li>Full-text search across all record types</li>
        <li>Export capability to PDF for offline review</li>
        <li>Auto-generated form numbering for traceability</li>
      </ul>
    </div>

    <div class="controls-section">
      <h3>8. External Auditor Access</h3>
      <div class="sqf-ref">SQF Edition 10</div>
      <ul>
        <li>Token-based access with time-limited sessions</li>
        <li>Scoped module access ‚Äî auditor only sees enabled modules</li>
        <li>Strictly read-only ‚Äî no create, edit, or delete capability</li>
        <li>Complete access logging with module, action, and record-level tracking</li>
        <li>Instant revocation capability by facility administrator</li>
      </ul>
    </div>

    <div class="controls-section">
      <h3>9. Application Hosting & Availability</h3>
      <div class="sqf-ref">GFSI BMR v2024</div>
      <ul>
        <li>Hosted on Vercel Pro with global CDN distribution</li>
        <li>Managed infrastructure with SSL certificates and DDoS protection</li>
        <li>99.99% uptime SLA</li>
        <li>Automatic scaling to handle peak usage</li>
      </ul>
    </div>

    <div class="controls-section">
      <h3>10. Data Integrity & Correction Controls</h3>
      <div class="sqf-ref">SQF 2.2.3.2</div>
      <ul>
        <li>All form fields must be completed before submission ‚Äî blank cells are not allowed</li>
        <li>Submitted records are locked from further editing</li>
        <li>System-generated timestamps cannot be modified by users</li>
        <li>Database constraints enforce data type and value validation</li>
      </ul>
    </div>

    <div style="margin-top:32px;padding:16px;background:var(--bg);border-radius:var(--radius);font-size:12px;color:var(--text-tertiary);text-align:center;">
      TulKenz OPS ‚Äî Document Security Controls ¬∑ Version 1.0 ¬∑ Effective ${fmtDate(new Date().toISOString())} ¬∑ Auto-generated compliance documentation
    </div>
  `;
}

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', init);
</script>

<!-- IMPORTANT: Replace YOUR_ANON_KEY with your Supabase anon/public key -->
<!-- Find it in Supabase Dashboard > Settings > API > anon/public -->
<script data-anon-key="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhcXp0b3pjbmtwbWd5dG5uamxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjI2NDAsImV4cCI6MjA4MzczODY0MH0.lL90-qamWRs8GXCvA-F7QcKiPx1WYUMs5OUjUi_1CjU"></script>

</body>
</html>
